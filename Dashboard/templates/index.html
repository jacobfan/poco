{% extends "base.html" %}

{% block style %}
    td.num {
        text-align: right;
    }
    td.na {
        text-align: right;
    }
{% endblock %}

{% block head %}


<script src="{{STATIC_URL}}highcharts-2.1.6/js/highcharts.js" type="text/javascript"></script>

<script type="text/javascript">
function renderChart_1(site_id, data) {
    var chart_dict = {
            chart: {
                renderTo: "chart-1",
                //marginRight: 30,
                marginBottom: 30
            },
            title: {
                text: "商品PV和UV图",
                x: -20
            },
            subtitle: {
                text: site_id,
                x: -20
            },
            xAxis: {
                categories: data.categories
            },
            yAxis: [{
                        title: {
                            text: '次数'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }]
                    },
                    {
                        title: {
                            text: '比率'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }],
                        opposite: true
                    }
            ],
            tooltip: {
                formatter: function() {
                    return '<b>' + this.series.name + '</b><br/>' +
                        this.x + ':' + this.y + '次';
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'right',
                verticalAlign: 'top',
                y: 10,
                borderWidth: 0,
                floating: true
            },
            series: [{"name": "商品PV",
                      "data": data.pv_v,
                      "type": "column",
                      "dataLabels": {
                        enabled: true
                        }
                      },
                     {"name": "商品UV",
                      "data": data.uv_v,
                      "type": "column",
                      "dataLabels": {
                        enabled: true
                        }
                      },
                    {"name": "PV/UV",
                      "data": data.pv_uv,
                      "type": "spline",
                      yAxis: 1
                     }
                ]
    };
    var chart = new Highcharts.Chart(chart_dict);
    return chart;
}


function renderChart_plo(site_id, data) {
    var chart_dict = {
            chart: {
                renderTo: "chart-plo",
                marginBottom: 30
            },
            title: {
                text: "商品订单数",
                x: -20
            },
            subtitle: {
                text: site_id,
                x: -20
            },
            xAxis: {
                categories: data.categories
            },
            yAxis: [{
                        title: {
                            text: '订单数'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }]
                    },
                    {
                        title: {
                            text: '比率'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }],
                        opposite: true
                    }
            ],
            tooltip: {
                formatter: function() {
                    return '<b>' + this.series.name + '</b><br/>' +
                        this.x + ':' + this.y + '单';
                }
            },
            plotOptions: {
                column: {
                    pointWidth: 20
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'right',
                verticalAlign: 'top',
                y: 10,
                borderWidth: 0,
                floating: true
            },
            series: [{
                       "name": "订单数",
                       "data": data.pv_plo,
                       "type": "column"
                     },

                    {"name": "订单数/商品UV",
                      "data": data.pv_plo_d_uv,
                      "type": "spline",
                      yAxis: 1
                     }
                ]
    };
    var chart = new Highcharts.Chart(chart_dict);
    return chart;
}

{% if user.is_admin %}
function renderChart_rec(site_id, data) {
    var chart_dict = {
            chart: {
                renderTo: "chart-rec",
                marginBottom: 30
            },
            title: {
                text: "商品推荐统计",
                x: -20
            },
            subtitle: {
                text: site_id,
                x: -20
            },
            xAxis: {
                categories: data.categories
            },
            yAxis: [{
                        title: {
                            text: '次数'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }]
                    } 
            ],
            tooltip: {
                formatter: function() {
                    return '<b>' + this.series.name + '</b><br/>' +
                        this.x + ':' + this.y + '次';
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'right',
                verticalAlign: 'top',
                y: 10,
                borderWidth: 0,
                floating: true
            },
            series: [{
                       "name": "推荐请求数",
                       "data": data.pv_rec,
                       "type": "column"
                     },
                     {
                       "name": "推荐点击数",
                       "data": data.clickrec,
                       "type": "column"
                     }
                ]
    };
    var chart = new Highcharts.Chart(chart_dict);
    return chart;
}
{% endif %}


function renderChart_avg_order_total(site_id, data) {
    var chart_dict = {
            chart: {
                renderTo: "chart-avg-order-total",
                //marginRight: 30,
                marginBottom: 30
            },
            title: {
                text: "平均客单价",
                x: -20
            },
            subtitle: {
                text: site_id,
                x: -20
            },
            xAxis: {
                categories: data.categories
            },
            yAxis: [{
                        title: {
                            text: '客单价'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }]
                    },
                    {
                        title: {
                            text: '客单价差'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }],
                        opposite: true
                    }

            ],
            tooltip: {
                formatter: function() {
                    return '<b>' + this.series.name + '</b><br/>' +
                        this.x + ':' + this.y + '元';
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'right',
                verticalAlign: 'top',
                y: 10,
                borderWidth: 0,
                floating: true
            },
            series: [{"name": "客单价",
                      "data": data.avg_order_total,
                      "type": "column",
                      "dataLabels": {
                        enabled: true
                        }
                      },
                      {"name": "有无推荐客单价差",
                      "data": data.avg_order_total_rec_delta,
                      "type": "spline",
                      "dataLabels": {
                        enabled: true
                        },
                      "yAxis": 1
                      }
                ]
    };
    var chart = new Highcharts.Chart(chart_dict);
    return chart;
}


function renderChart_total_sales(site_id, data) {
    var chart_dict = {
            chart: {
                renderTo: "chart-total-sales",
                //marginRight: 30,
                marginBottom: 30
            },
            title: {
                text: "总销售金额",
                x: -20
            },
            subtitle: {
                text: site_id,
                x: -20
            },
            xAxis: {
                categories: data.categories
            },
            yAxis: [{
                        title: {
                            text: '金额'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }]
                    },
                    {
                        title: {
                            text: '销售金额差'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }],
                        opposite: true
                    }
            ],
            tooltip: {
                formatter: function() {
                    return '<b>' + this.series.name + '</b><br/>' +
                        this.x + ':' + this.y + '元';
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'right',
                verticalAlign: 'top',
                y: 10,
                borderWidth: 0,
                floating: true
            },
            series: [{"name": "总销售金额",
                      "data": data.total_sales,
                      "type": "column",
                      "dataLabels": {
                        enabled: true
                        }
                      },
                      {"name": "有无推荐销售金额差",
                      "data": data.total_sales_rec_delta,
                      "type": "spline",
                      "dataLabels": {
                        enabled: true
                        },
                        yAxis: 1
                      }
                ]
    };
    var chart = new Highcharts.Chart(chart_dict);
    return chart;
}


{% if user.is_admin %}
function renderChart_unique_sku(site_id, data) {
    var chart_dict = {
            chart: {
                renderTo: "chart-unique-sku",
                marginBottom: 30
            },
            title: {
                text: "平均Unique SKU",
                x: -20
            },
            subtitle: {
                text: site_id,
                x: -20
            },
            xAxis: {
                categories: data.categories
            },
            yAxis: [{
                        title: {
                            text: '平均Unique SKU'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }]
                    }
            ],
            tooltip: {
                formatter: function() {
                    return '<b>' + this.series.name + '</b><br/>' +
                        this.x + ':' + this.y;
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'right',
                verticalAlign: 'top',
                y: 10,
                borderWidth: 0,
                floating: true
            },
            series: [{
                       "name": "平均Unique SKU",
                       "data": data.avg_unique_sku,
                       "type": "spline"
                     },
                     {
                       "name": "平均商品件数",
                       "data": data.avg_item_amount,
                       "type": "spline"
                     }

                ]
    };
    var chart = new Highcharts.Chart(chart_dict);
    return chart;
}
{% endif %}


function renderChart_rec_ratios(site_id, data) {
    var chart_dict = {
            chart: {
                renderTo: "chart-rec-ratios",
                marginBottom: 30
            },
            title: {
                text: "推荐点击/请求比",
                x: -20
            },
            subtitle: {
                text: site_id,
                x: -20
            },
            xAxis: {
                categories: data.categories
            },
            yAxis: [{
                        title: {
                            text: '点击/请求比'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }]
                    }
            ],
            tooltip: {
                formatter: function() {
                    return '<b>' + this.series.name + '</b><br/>' +
                        this.x + ':' + this.y;
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'right',
                verticalAlign: 'top',
                y: 25,
                borderWidth: 0,
                floating: true
            },
            series: [
                    {
                       "name": "看了也看",
                       "data": data["click_rec_show_ratio_recvav"],
                       "type": "spline"
                     },
                    {
                       "name": "根据购买历史",
                       "data": data["click_rec_show_ratio_recph"],
                       "type": "spline"
                     },
                    {
                       "name": "买了也买",
                       "data": data["click_rec_show_ratio_recbab"],
                       "type": "spline"
                     },
                    {
                       "name": "一起买",
                       "data": data["click_rec_show_ratio_recbtg"],
                       "type": "spline"
                     },
                    {
                       "name": "看了最终买",
                       "data": data["click_rec_show_ratio_recvub"],
                       "type": "spline"
                     },
                    {
                       "name": "根据浏览历史",
                       "data": data["click_rec_show_ratio_recbobh"],
                       "type": "spline"
                     },
                    {
                       "name": "根据购物车",
                       "data": data["click_rec_show_ratio_recsc"],
                       "type": "spline"
                     }
                ]
    };
    var chart = new Highcharts.Chart(chart_dict);
    return chart;
}


{% if user.is_admin %}
function renderChart_rec_by_type(site_id, data, action_name) {
    var action_name2cname = {
        "recvav": "看了也看",
        "recph": "根据购买历史",
        "recbab": "买了也买",
        "recbtg": "一起买",
        "recvub": "看了最终买",
        "recbobh": "根据浏览历史",
        "recsc": "根据购物车"
    };
    var chart_dict = {
            chart: {
                renderTo: "chart-rec-" + action_name,
                marginBottom: 30
            },
            title: {
                text: "商品推荐统计 - " + action_name2cname[action_name],
                x: -20
            },
            subtitle: {
                text: site_id,
                x: -20
            },
            xAxis: {
                categories: data.categories
            },
            yAxis: [{
                        title: {
                            text: '次数'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }]
                    },
                    {
                        title: {
                            text: '点击/请求比'
                        },
                        plotLines: [{
                            value: 0, width: 1, color: '#808080'
                        }],
                        opposite: true
                    }
            ],
            tooltip: {
                formatter: function() {
                    return '<b>' + this.series.name + '</b><br/>' +
                        this.x + ':' + this.y + '次';
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'right',
                verticalAlign: 'top',
                y: 25,
                borderWidth: 0,
                floating: true
            },
            series: [{
                       "name": "推荐请求数",
                       "data": data["recommendation_request_count_" + action_name],
                       "type": "column"
                     },
                    {
                       "name": "推荐展示数",
                       "data": data["recommendation_show_count_" + action_name],
                       "type": "column"
                     },

                     {
                       "name": "推荐点击数",
                       "data": data["click_rec_count_" + action_name],
                       "type": "column"
                     },
                    {
                       "name": "推荐点击/请求比",
                       "data": data["click_rec_show_ratio_" + action_name],
                       "type": "spline",
                       yAxis: 1
                     },
                ]
    };
    var chart = new Highcharts.Chart(chart_dict);
    return chart;
}
{% endif %}
</script>

<script type="text/javascript">
    function fillCharts(site_id, statistics) {
        try{
            renderChart_1(site_id, statistics);
            renderChart_plo(site_id, statistics);
            {% if user.is_admin %}
            renderChart_rec(site_id, statistics);
            {% endif %}
            renderChart_avg_order_total(site_id, statistics);
            renderChart_total_sales(site_id, statistics);
            {% if user.is_admin %}
            renderChart_unique_sku(site_id, statistics);
            renderChart_rec_by_type(site_id, statistics, "recvav");
            renderChart_rec_by_type(site_id, statistics, "recph");
            renderChart_rec_by_type(site_id, statistics, "recbab");
            renderChart_rec_by_type(site_id, statistics, "recbtg");
            renderChart_rec_by_type(site_id, statistics, "recvub");
            renderChart_rec_by_type(site_id, statistics, "recbobh");
            renderChart_rec_by_type(site_id, statistics, "recsc");
            {% endif %}
            renderChart_rec_ratios(site_id, statistics);
        }catch(err){}
    };

    function updateSiteStatistics(site_id) {
        $.getJSON("/ajax/get_site_statistics", {site_id: site_id},
                function(data, textStatus, jqXHR) {
                    if (data.code == 0 && data.site.items_count > 0 ) {
                        var site_data = data.site;
                        $("#items-count").html(site_data["items_count"]);
                        fillCharts(site_data.site_id, site_data.statistics);
                    }
                }
            );
    };
    
    function update_statistics_from_site_selector() {
        var site_id = $("#site_selector").val();
        updateSiteStatistics(site_id);
        $("#site_items_list_link").attr("href", "/site_items_list?site_id=" + site_id);
        $("#update_category_groups_link").attr("href", "/update_category_groups?site_id=" + site_id);
    }

    $(function() {
        update_statistics_from_site_selector();
        $("#site_selector").change(function() {
            update_statistics_from_site_selector();
        });
    });

    
</script>
{% endblock %}

{% block content-area %}
<div>
    <div>
        <select id="site_selector">
        {% for site in sites %}
            {% if forloop.first %}
                <option value="{{site.site_id}}" selected>{{site.site_name}}</option>
            {% else %}
                <option value="{{site.site_id}}">{{site.site_name}}</option>
            {% endif %}
        {% endfor %}
        </select>
        
    </div>
    <div>
        收录商品数：<span id="items-count">N/A</span>
    </div>
    <div>
        <a id="site_items_list_link" href="/site_items_list?site_id={{site.site_id}}">查看商品列表</a>
    </div>
    <div>
        <a id="update_category_groups_link" href="/update_category_groups?site_id={{site.site_id}}">编辑商品分类组别</a>
    </div>
    <div id="chart-1" style="width:800px;height:300px;"></div>
    <div id="chart-plo" style="width:800px;height:300px;"></div>
    {% if user.is_admin %}
    <div id="chart-rec" style="width:800px;height:300px; margin-top: 30px;"></div>
    {% endif %}
    <div id="chart-avg-order-total" style="width:800px;height:300px; margin-top: 30px;"></div>
    <div id="chart-total-sales" style="width:800px;height:300px; margin-top: 30px;"></div>
    {% if user.is_admin %}
    <div id="chart-unique-sku" style="width:800px;height:300px; margin-top: 30px;"></div>
    <div id="chart-rec-recvav" style="width:800px;height:300px; margin-top: 30px;"></div>
    <div id="chart-rec-recph" style="width:800px;height:300px; margin-top: 30px;"></div>
    <div id="chart-rec-recbab" style="width:800px;height:300px; margin-top: 30px;"></div>
    <div id="chart-rec-recbtg" style="width:800px;height:300px; margin-top: 30px;"></div>
    <div id="chart-rec-recvub" style="width:800px;height:300px; margin-top: 30px;"></div>
    <div id="chart-rec-recbobh" style="width:800px;height:300px; margin-top: 30px;"></div>
    <div id="chart-rec-recsc" style="width:800px;height:300px; margin-top: 30px;"></div>
    {% endif %}
    <div id="chart-rec-ratios" style="width:800px;height:600px; margin-top: 30px;"></div>
</div>
{% endblock %}
